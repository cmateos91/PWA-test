<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Checker - Brave</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 5px 10px; 
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }
        .ok { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .brave-tip {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîç PWA Checker para Brave</h1>
    
    <div class="brave-tip">
        <h3>‚ö†Ô∏è Problemas conocidos con PWAs en Brave:</h3>
        <ul>
            <li>Brave es m√°s estricto que Chrome con los requisitos PWA</li>
            <li>A veces necesitas recargar la p√°gina varias veces</li>
            <li>El bot√≥n puede tardar 30-60 segundos en aparecer</li>
            <li>Algunos sitios necesitan configuraci√≥n especial</li>
        </ul>
    </div>

    <div class="card">
        <h2>Estado del navegador</h2>
        <div id="browserStatus"></div>
    </div>

    <div class="card">
        <h2>Verificaci√≥n PWA</h2>
        <div id="pwaChecks"></div>
    </div>

    <div class="card">
        <h2>Acciones</h2>
        <button onclick="checkAll()">üîÑ Verificar Todo</button>
        <button onclick="clearCaches()">üóëÔ∏è Limpiar Cach√©s</button>
        <button onclick="testInstall()">üì± Probar Instalaci√≥n</button>
        <button onclick="forceReload()">‚ôªÔ∏è Recargar Forzado</button>
    </div>

    <div class="card">
        <h2>Registro de eventos</h2>
        <div id="eventLog"></div>
    </div>

    <script>
        let deferredPrompt = null;
        const log = (msg, type = 'info') => {
            const time = new Date().toLocaleTimeString();
            document.getElementById('eventLog').innerHTML += 
                `<div class="status ${type}">[${time}] ${msg}</div>`;
        };

        //verificar navegador
        function checkBrowser() {
            const ua = navigator.userAgent;
            const isBrave = navigator.brave && navigator.brave.isBrave;
            const isChrome = ua.includes('Chrome');
            const version = ua.match(/Chrome\/(\d+)/)?.[1];
            
            let html = '';
            
            if (isBrave || ua.includes('Brave')) {
                html += '<p class="status ok">‚úì Navegador Brave detectado</p>';
            } else if (isChrome) {
                html += '<p class="status warning">‚ö†Ô∏è Chrome detectado (no Brave)</p>';
            } else {
                html += '<p class="status error">‚úó Navegador no compatible</p>';
            }
            
            html += `<p>User Agent: <code>${ua}</code></p>`;
            html += `<p>Versi√≥n Chrome: ${version || 'No detectada'}</p>`;
            html += `<p>URL actual: ${location.href}</p>`;
            html += `<p>Protocolo: ${location.protocol} ${location.protocol === 'https:' ? '‚úì' : '‚úó'}</p>`;
            
            document.getElementById('browserStatus').innerHTML = html;
        }

        //verificar pwa
        async function checkPWA() {
            let html = '';
            let score = 0;
            
            //https
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                html += '<p class="status ok">‚úì HTTPS/localhost</p>';
                score++;
            } else {
                html += '<p class="status error">‚úó Requiere HTTPS</p>';
            }
            
            //service worker
            if ('serviceWorker' in navigator) {
                html += '<p class="status ok">‚úì Service Worker soportado</p>';
                const regs = await navigator.serviceWorker.getRegistrations();
                if (regs.length > 0) {
                    html += '<p class="status ok">‚úì Service Worker registrado</p>';
                    score++;
                } else {
                    html += '<p class="status warning">‚ö†Ô∏è Service Worker no registrado</p>';
                }
            } else {
                html += '<p class="status error">‚úó Service Worker no soportado</p>';
            }
            
            //manifest
            try {
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    const response = await fetch(manifestLink.href);
                    const manifest = await response.json();
                    html += '<p class="status ok">‚úì Manifest encontrado</p>';
                    
                    //verificar campos requeridos
                    const required = ['name', 'short_name', 'icons', 'start_url', 'display'];
                    const missing = required.filter(field => !manifest[field]);
                    
                    if (missing.length === 0) {
                        html += '<p class="status ok">‚úì Campos requeridos presentes</p>';
                        score++;
                    } else {
                        html += `<p class="status warning">‚ö†Ô∏è Faltan campos: ${missing.join(', ')}</p>`;
                    }
                    
                    //verificar iconos
                    if (manifest.icons && manifest.icons.length > 0) {
                        const sizes = manifest.icons.map(i => i.sizes);
                        const has192 = sizes.some(s => s && s.includes('192'));
                        const has512 = sizes.some(s => s && s.includes('512'));
                        
                        if (has192 && has512) {
                            html += '<p class="status ok">‚úì Iconos 192x192 y 512x512</p>';
                            score++;
                        } else {
                            html += '<p class="status warning">‚ö†Ô∏è Faltan iconos requeridos</p>';
                        }
                    }
                    
                    //mostrar manifest
                    html += '<details><summary>Ver Manifest</summary><pre>' + 
                           JSON.stringify(manifest, null, 2) + '</pre></details>';
                } else {
                    html += '<p class="status error">‚úó No hay link a manifest</p>';
                }
            } catch (e) {
                html += '<p class="status error">‚úó Error al cargar manifest: ' + e.message + '</p>';
            }
            
            //puntuaci√≥n
            html = `<h3>Puntuaci√≥n: ${score}/4</h3>` + html;
            
            //recomendaciones para brave
            if (score < 4) {
                html += '<div class="brave-tip"><strong>Recomendaciones para Brave:</strong><ul>';
                html += '<li>Aseg√∫rate de que TODOS los iconos existan</li>';
                html += '<li>Prueba con "display": "standalone" o "fullscreen"</li>';
                html += '<li>A√±ade "scope": "/" al manifest</li>';
                html += '<li>Espera 30-60 segundos despu√©s de cargar</li>';
                html += '<li>Intenta recargar la p√°gina varias veces</li>';
                html += '</ul></div>';
            }
            
            document.getElementById('pwaChecks').innerHTML = html;
        }

        //eventos pwa
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log('¬°Evento beforeinstallprompt capturado!', 'ok');
            log('El bot√≥n de instalaci√≥n deber√≠a aparecer ahora', 'ok');
        });

        window.addEventListener('appinstalled', () => {
            log('¬°App instalada correctamente!', 'ok');
        });

        //funciones de acci√≥n
        function checkAll() {
            document.getElementById('eventLog').innerHTML = '';
            log('Iniciando verificaci√≥n completa...');
            checkBrowser();
            checkPWA();
        }

        async function clearCaches() {
            log('Limpiando cach√©s...');
            
            if ('serviceWorker' in navigator) {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let reg of regs) {
                    await reg.unregister();
                }
                log('Service Workers desregistrados', 'ok');
            }
            
            if ('caches' in window) {
                const names = await caches.keys();
                for (let name of names) {
                    await caches.delete(name);
                }
                log('Cach√©s eliminados', 'ok');
            }
            
            log('Recarga la p√°gina para reiniciar', 'warning');
        }

        function testInstall() {
            if (deferredPrompt) {
                log('Mostrando prompt de instalaci√≥n...');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        log('Instalaci√≥n aceptada', 'ok');
                    } else {
                        log('Instalaci√≥n rechazada', 'warning');
                    }
                    deferredPrompt = null;
                });
            } else {
                log('No hay prompt de instalaci√≥n disponible', 'error');
                log('Posibles razones:', 'warning');
                log('1. La app ya est√° instalada');
                log('2. Falta alg√∫n requisito PWA');
                log('3. Brave necesita m√°s tiempo (espera 30-60 seg)');
                log('4. Intenta recargar la p√°gina');
            }
        }

        function forceReload() {
            log('Recargando p√°gina...');
            setTimeout(() => {
                location.reload(true);
            }, 500);
        }

        //verificar al cargar
        window.addEventListener('load', () => {
            checkAll();
            
            //verificar peri√≥dicamente
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                checkCount++;
                if (deferredPrompt) {
                    log(`Prompt disponible despu√©s de ${checkCount * 5} segundos`, 'ok');
                    clearInterval(checkInterval);
                } else if (checkCount > 12) {
                    log('No se detect√≥ prompt despu√©s de 60 segundos', 'warning');
                    clearInterval(checkInterval);
                }
            }, 5000);
        });
    </script>
</body>
</html>